{% if ssh_has_bastion %}
{% set vars={'hosts': ''} %}
{% set user='' %}

{% for h in groups['all'] %}
{% if h != 'bastion' and h != 'localhost' %}
{% if vars.update({'hosts': vars['hosts'] + ' ' + (hostvars[h].get('ansible_ssh_host') or hostvars[h]['ansible_host'])}) %}{% endif %}
{% endif %}
{% endfor %}

Host {{ ssh_bastion_ip }}
  Hostname {{ ssh_bastion_ip }}
  StrictHostKeyChecking no
  ControlMaster auto
  ControlPath ~/.ssh/ansible-%r@%h:%p
  ControlPersist 5m
{% if ansible_ssh_private_key_file is defined %}  IdentityFile {{ ansible_ssh_private_key_file }}{% endif %}


Host {{ vars['hosts'] }}
  ProxyCommand ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -W %h:%p {{ ssh_bastion_user }}@{{ ssh_bastion_ip }} {% if ansible_ssh_private_key_file is defined %}-i {{ ansible_ssh_private_key_file }}{% endif %}

  StrictHostKeyChecking no
{% if ansible_ssh_private_key_file is defined %}  IdentityFile {{ ansible_ssh_private_key_file }}{% endif %}
{% endif %}
